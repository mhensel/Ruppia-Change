---
title: "Ruppia-change"
author: "Marc Hensel"
date: "3/16/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r load packages, echo=FALSE}
#devtools::install_github("dill/beyonce")
library(tidyverse); library(readxl); library(patchwork); library(lme4); library(DHARMa); library(piecewiseSEM); library(nlme); library(performance); library(geomtextpath)
```


```{r load in data from R drive}
#setwd("~/Documents/R projects/Ruppia/Ruppia-Change")
#Baywide SAV cover, Ru Zo in here as well. 
SAV <- read.csv("/Volumes/savshare2/Current Projects/Ruppia/Data/RmSEM datasets/BaywideSAV_RuZo.csv")
#SEM dataset, Rm_Env w NAs removed 
#Stations
Rm_SEM <- read.csv("/Volumes/savshare2/Current Projects/Ruppia/Data/RmSEM datasets/Rm_SEM.csv")
#Subestuaries
RmSubE988_SEM <- read.csv("/Volumes/savshare2/Current Projects/Ruppia/Data/RmSEM datasets/RmSubE988_SEM.csv")
RmSubE_Env982 <- read.csv("/Volumes/savshare2/Current Projects/Ruppia/Data/RmSEM datasets/RmSubE_Env982.csv")
#Flow data
connodisc <- read.csv("/Volumes/savshare2/Current Projects/Ruppia/Data/RmSEM datasets/conno_discharge.csv")



SE <- function(x) sd(x) / sqrt(length(x)) # Create own function

```


```{r run this chunk to create some tables}
SAV_time.tbl = SAV %>% #group_by(Year) %>%
  mutate(RuChange = meanRu - lag(meanRu, n = 1L), 
         ZoChange = meanZo - lag(meanZo, n = 1L), 
         BaeChange = Hectares - lag(Hectares, n = 1L)) %>%
  select(year, meanRu, RuChange, meanZo, ZoChange, Hectares, BaeChange)

#% change from 84-18 in Widge, Eel, Total to the max recoveryd: 
widgeRecoChange = (17952/2907)*100
eelRecoChange = (7839/9740) *100
baeRecoChange = (43736/15469) * 100 

#do some Data wrangling to get the long term mean and variance around it
SAV_stability = SAV %>% drop_na() %>% #drop the 1988 NA
  mutate(long.meanRu = mean(meanRu, na.rm = T), long.meanZo = mean(meanZo, na.rm = T), 
         long.meanBae = mean(Hectares, na.rm = T)) %>%
  mutate(predRu = predict(lm(meanRu ~ Year, data = .)), #predicted, to fit the detrend
         predZo = predict(lm(meanZo ~ Year, data = .)), 
         predBae = predict(lm(Hectares ~ Year, data = .))) %>% 
  mutate(detreRu = (meanRu - predRu) + long.meanRu , #plus final year's data
         detreZo = (meanZo - predZo) + long.meanZo, 
         detreBae = (Hectares - predBae) + long.meanBae) %>%
  mutate(long.meandevRu = meanRu/long.meanRu, long.meandevZo = meanZo/long.meanZo, 
         long.detredevRu = detreRu/long.meanRu, long.detredevZo = detreZo/long.meanZo, 
         long.meandevBae = Hectares/long.meanBae, long.detredevBae = detreBae/long.meanBae) %>% 
  mutate(varRu = var(meanRu, na.rm = T), varZo = var(meanZo, na.rm = T), 
         varBae = var(Hectares, na.rm = T)) %>%
  mutate(CVRu = sd(meanRu, na.rm = T)/mean(meanRu, na.rm = T), CVZo = sd(meanZo, na.rm = T)/ mean(meanZo, na.rm = T), 
         CVBae = sd(Hectares, na.rm = T)/mean(Hectares, na.rm = T))

```


```{r Fig 2a Baewide SAV change,echo=F}

baywideRuZoSAV <- 
  ggplot(data = SAV, aes(x = Year, y = Hectares)) + 
  stat_summary(data = SAV %>% filter(Zone == "Baywide"), aes(x = Year, y = Hectares/1000), color = "black", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 2) +
  #stat_summary(data = baywidetotals %>% filter(Zone == "Mesohaline"), aes(x = Year, y = Hectares), color = "red", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 1.5) +
  stat_summary(data = SAV, aes(x = year, y = meanRu/1000), color = "green", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 2) +
  stat_summary(data = SAV, aes(x = Year, y = meanZo/1000), color = "blue", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 1.5) +
  scale_x_continuous(n.breaks = 10) +
  ylab("SAV Area \n(K HA)") + xlab("") +
  theme_bw(base_size=16)  +
  theme(axis.title.y = element_text(size=14),
    #    plot.margin = unit(c(1,1,1,1), "cm"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right", legend.title = element_blank())
baywideRuZoSAV
```

```{r Fig 2a Proportional SAV change,echo=F}
PropBay <- 
  ggplot(data = SAV) + 
  stat_summary(aes(x = Year, y = perBayZo),color = "blue", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 2) +
  stat_summary(aes(x = Year, y = perBayRu), color = "green", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 2)+
  scale_colour_manual(labels = (c("Ruppia", "Zostera")), values=c("green", "blue")) +
  scale_x_continuous(n.breaks = 10) + 
  ylim(0, .6)+
  ylab("Proportion of Baywide\n SAV Area (per species)") + xlab("") +
  theme_bw(base_size=16)  +
  theme(axis.title.y = element_text(size=14),
 #       plot.margin = unit(c(1,1,1,1), "cm"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right", legend.title = element_blank())
PropBay
```

#Temp portion of Fig2a
```{r Fig 2a TEMP on right axis SAV change,echo=F}
SAVCommDensWQ_ForPred.with0s = vroom::vroom("/Volumes/savshare2/Current Projects/Predicting-SAV/data/communityDFs/SAVCommDensWQ_ForPredictions.with0s.csv")

my.ylab = expression(atop(paste("Summer Temperature, "(mean, degree,"C"))))

TempBay = 
  SAVCommDensWQ_ForPred.with0s %>%
  filter(SpCluster %in% c("Ruppia", "Zostera", "RuZo")) %>%
  group_by(STATION, year) %>% 
  mutate(year.y1 = year - 1) %>% select(year.y1, Temp.sumy1me) %>% 
  filter(!year == "1985") %>% ungroup() %>% #outlier year (no sampling done in summer)
    ggplot(data = .) + 
    stat_summary(aes(x = year.y1, y = Temp.sumy1me), color = "dark red", fun.data = mean_cl_normal, 
                 geom = "line", size = 1.5, alpha = .5) +
    stat_summary(aes(x = year.y1, y = Temp.sumy1me), fun.data = mean_se, 
                 geom = "pointrange", size = .5, alpha = .4, color = "dark red") +
#   geom_smooth(aes(x = year, y = Temp.sumy1me), method = "lm", se = T, color = "black", size = 1) +
    scale_x_continuous(n.breaks = 10) + 
    scale_y_continuous(position = "right") +
    ylab(my.ylab) + xlab("") +
    theme_bw(base_size=16)  +
  theme(axis.title.y = element_text(size=14),
 #       plot.margin = unit(c(1,1,1,1), "cm"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right", legend.title = element_blank())
TempBay



```


#Figure 2c Variance around long term mean over time

```{r Figure 2c variance}
VarBae = 
ggplot(data = SAV_stability) + 
  stat_summary(aes(x = year, y = long.detredevRu), color = "green", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 2.3) +
  stat_summary(aes(x = Year, y = long.detredevZo), color = "blue", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 2.3) +
    stat_summary(aes(x = Year, y = long.detredevBae), color = "black", fun.data = mean_cl_normal, geom = "line", fun.args = list(mult = 1), size = 1.3, alpha = .5) +
  geom_hline(yintercept=1, linetype="dashed", color = "red", size = .8) +
  scale_x_continuous(n.breaks = 10) +
  labs(y = expression(paste("Deviance around long-term mean \n of total Baywide areal cover")), x = "Year") +
  ylim(0,2) +
  theme_bw(base_size=16)  +
  theme(axis.title.y = element_text(size=14),
        plot.margin = unit(c(1,1,1,1), "cm"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right", legend.title = element_blank())
VarBae
#stat test
ks.test(SAV_stability$long.meandevRu, SAV_stability$long.meandevZo)

```


```{r, build Fig 1}
SAV_time.tbl

Fig1patch =  PropBay / baywideRuZoSAV / VarBae + 
    theme(plot.margin = unit(c(1,1,1,1), "cm")) #+
  #plot_annotation(tag_levels = 'A') & 
  #theme(plot.tag = element_text(size = 8))

Fig1patch

TempBay

```

#SEM for Mainstem Analysis
```{r Stations SEM}
#Filter out stations that had 0s three years in a row
RmSEMZeros = Rm_SEM  %>% group_by(STATION) %>%
 mutate(dens.weight.mean.y2 = lag(dens.weight.mean.y1)) %>%  #select(STATION, year, dens.weight.mean, dens.weight.mean.y1, dens.weight.mean.y2)
  dplyr::filter(dens.weight.mean == 0 & dens.weight.mean.y1 == 0 & dens.weight.mean.y2 == 0) 

Rm_SEM.No0 = anti_join(Rm_SEM, RmSEMZeros) %>% #971-filter out just y and y1, 1041 filter y2
  drop_na()

RmSEMNo0LOG.sem <- psem(
  ChlAsp <- lme(log10(ChlA.spme) ~
                  log10(Temp.spme) +
                  log10(TP.spme) +
                  log10(TN.spme),
                random = ~ 1 | STATION,
                correlation = corARMA(form = ~ 1 | STATION, q = 1),
                control = lmeControl(opt = "optim"),
                data = Rm_SEM.No0),
  Seccsp <- lme(log10(Secc.spme) ~
                  log10(ChlA.spme) +
                  log10(Temp.spme) +
                  log10(TN.spme) +
                  log10(TP.spme),
                random = ~ 1 | STATION,
                correlation = corARMA(form = ~ 1 | STATION, q = 1),
                control = lmeControl(opt = "optim"),
                data = Rm_SEM.No0),
  RuInt <- lme(dens.percomp.change ~
                 dens.percomp.y1 +
                 log10(Sal.spme) + 
                 log10(ChlA.spme) + 
                 log10(TP.spme) +
                 log10(TN.spme) + 
                 log10(Secc.spme) +
                 log10(Temp.spme) +
                 (log10(Temp.spme):dens.percomp.y1) +
                 (dens.percomp.y1:log10(Sal.spme)) + 
                 (dens.percomp.y1:log10(ChlA.spme)) + 
                 (log10(TP.spme):dens.percomp.y1) +
                 (log10(TN.spme):dens.percomp.y1) +
                 (log10(Secc.spme):dens.percomp.y1),
               random = ~ 1 | STATION,
               correlation = corARMA(form = ~ 1 | STATION, q = 1),
               control = lmeControl(opt = "optim"),
               data = Rm_SEM.No0),
  log10(TN.spme) %~~% log10(TP.spme),
  log10(Secc.spme) %~~% log10(Sal.spme),
  log10(ChlA.spme) %~~% log10(Sal.spme),
  #log10(TP.spme) %~~% log10(Sal.spme),
  #log10(TN.spme) %~~% log10(Sal.spme),
  data = Rm_SEM.No0)


summary(RmSEMNo0LOG.sem)
RmBayLOG.coeftab = coefs(RmSEMNo0LOG.sem)
dSep(RmSEMNo0LOG.sem)
fisherC(RmSEMNo0LOG.sem)


```


```{r Station SEM coef tables}

#Regression coeff
RmBayLOG.coeftab

```

```{r testing out No0 and NoInt models}

###Trying one out with absolutely no 0s. ####
#Ok this is super insightful actually. Overall, the Stats are great but the R2 are lower (.32 for dens change). The same variables and almost exactly same effect sizes are important (Sal, Chla, TN direct) BUT y1 -> change is INSIGNIFICANT (but negative). So that effect is driven by 0s for sure!! 

#  Fisher's C = 3.871 with P-value = 0.424 and on 4 degrees of freedom

No0.sem <- psem(
  ChlAsp <- lme(log10(ChlA.spme) ~
                  log10(Temp.spme) +
                  log10(TP.spme) +
                  log10(TN.spme),
                random = ~ 1 | STATION,
                correlation = corARMA(form = ~ 1 | STATION, q = 1),
                control = lmeControl(opt = "optim"),
                data = Rm_SEM %>% filter(!dens.weight.mean == 0)),
  Seccsp <- lme(log10(Secc.spme) ~
                  log10(ChlA.spme) +
                  log10(Temp.spme) +
                  log10(TN.spme) +
                  log10(TP.spme),
                random = ~ 1 | STATION,
                correlation = corARMA(form = ~ 1 | STATION, q = 1),
                control = lmeControl(opt = "optim"),
                data = Rm_SEM %>% filter(!dens.weight.mean == 0)),
  RuInt <- lme(dens.percomp.change ~
                 dens.percomp.y1 +
                 log10(Sal.spme) + 
                 log10(ChlA.spme) + 
                 log10(TP.spme) +
                 log10(TN.spme) + 
                 log10(Secc.spme) +
                 log10(Temp.spme) +
                 (log10(Temp.spme):dens.percomp.y1) +
                 (dens.percomp.y1:log10(Sal.spme)) + 
                 (dens.percomp.y1:log10(ChlA.spme)) + 
                 (log10(TP.spme):dens.percomp.y1) +
                 (log10(TN.spme):dens.percomp.y1) +
                 (log10(Secc.spme):dens.percomp.y1),
               random = ~ 1 | STATION,
               correlation = corARMA(form = ~ 1 | STATION, q = 1),
               control = lmeControl(opt = "optim"),
               data = Rm_SEM %>% filter(!dens.weight.mean == 0)),
  log10(TN.spme) %~~% log10(TP.spme),
  log10(Secc.spme) %~~% log10(Sal.spme),
  log10(ChlA.spme) %~~% log10(Sal.spme),
  #log10(TP.spme) %~~% log10(Sal.spme),
  #log10(TN.spme) %~~% log10(Sal.spme),
  data = Rm_SEM %>% filter(!dens.weight.mean == 0))

summary(No0.sem)

###Now testing out no interactions####

# Fisher's C = 1.712 with P-value = 0.789 and on 4 degrees of freedom
#Individual R-squared:
  
#  Response method Marginal Conditional
#ChlA.spme   none     0.33        0.40
#Secc.spme   none     0.37        0.70
#dens.percomp.change   none     0.43        0.56

#Direct only shows strongest effect of TN, twice as strong as Chla (-.3, -.16). y1 effect is there but smaller, and there is NO salinity effect!

RmSEMNoIntLOG.sem <- psem(
  ChlAsp <- lme(log10(ChlA.spme) ~
                  log10(Temp.spme) +
                  log10(TP.spme) +
                  log10(TN.spme),
                random = ~ 1 | STATION,
                correlation = corARMA(form = ~ 1 | STATION, q = 1),
                control = lmeControl(opt = "optim"),
                data = Rm_SEM.No0),
  Seccsp <- lme(log10(Secc.spme) ~
                  log10(ChlA.spme) +
                  log10(Temp.spme) +
                  log10(TN.spme) +
                  log10(TP.spme),
                random = ~ 1 | STATION,
                correlation = corARMA(form = ~ 1 | STATION, q = 1),
                control = lmeControl(opt = "optim"),
                data = Rm_SEM.No0),
  RuInt <- lme(dens.percomp.change ~
                 dens.percomp.y1 +
                 log10(Sal.spme) + 
                 log10(ChlA.spme) + 
                 log10(TP.spme) +
                 log10(TN.spme) + 
                 log10(Secc.spme) +
                 log10(Temp.spme) ,
               random = ~ 1 | STATION,
               correlation = corARMA(form = ~ 1 | STATION, q = 1),
               control = lmeControl(opt = "optim"),
               data = Rm_SEM.No0),
  log10(TN.spme) %~~% log10(TP.spme),
  log10(Secc.spme) %~~% log10(Sal.spme),
  log10(ChlA.spme) %~~% log10(Sal.spme),
  #log10(TP.spme) %~~% log10(Sal.spme),
  #log10(TN.spme) %~~% log10(Sal.spme),
  data = Rm_SEM.No0)

summary(RmSEMNoIntLOG.sem)


```


#Subestuaries SEM
```{r Subestuaries SEM}

RmSubE988_SEM = RmSubE_Env982 %>% 
  filter(ptp.adj > 0) %>% drop_na() #piecewiseSEM doesnt like NAs
 # mutate(ptp.adj = ptp.adj + 0.000000000001) #filter out these 20 points that make you log10(0)

RmSubE_Env982

RmSubEN.sem <-  psem(
  tss <- lme(log10(tssx.adj) ~ log10(flow) + Agro + Developed,
             random = ~ 1 | SUBEST_ID,
             correlation = corARMA(form = ~ 1 | SUBEST_ID, q = 2), 
             data = RmSubE988_SEM),
  nptn <- lme(log10(nptn.adj) ~  log10(flow) + Agro +Developed ,
              random = ~ 1 | SUBEST_ID,
              correlation = corARMA(form = ~ 1 | SUBEST_ID, q = 2),
              data = RmSubE988_SEM),
  ptp <- lme(log10(ptp.adj) ~  log10(flow) +  Developed + Agro,
             random = ~ 1 | SUBEST_ID,
             correlation = corARMA(form = ~ 1 | SUBEST_ID, q = 2),
             data = RmSubE988_SEM),
  Ruchange <- lme(dens.percomp.change ~
                    dens.percomp.y1 +
                    log10(flow) +
                    log10(nptn.adj) +
                    log10(tssx.adj) +
                    log10(ptp.adj)+
                    dens.percomp.y1:log10(ptp.adj) +
                    dens.percomp.y1:log10(flow) +
                    dens.percomp.y1:log10(nptn.adj) +
                    dens.percomp.y1:log10(tssx.adj),
                  random = ~ 1 | SUBEST_ID,
                  correlation = corARMA(form = ~ 1 | SUBEST_ID, q = 2),
                  data = RmSubE988_SEM), 
  log10(nptn.adj) %~~% log10(tssx.adj),
  #log10(ptp.adj) %~~% log10(tssx.adj),
  #log10(nptn.adj) %~~% log10(ptp.adj),
  data = RmSubE988_SEM)
summary(RmSubEN.sem)
RmSubE.coeftab = coefs(RmSubEN.sem)
dSep(RmSubEN.sem)
fisherC(RmSubEN.sem)
#r.squaredGLMM(RmSubELOGtrim.N.sem)


#  Fisher.C df P.Value
#    9.626 14   0.789


```





```{r}
RmSubEtable = as_tibble(RmSubE.coeftab %>% select(-9))
resp = c("TSS", "TSS", "TSS", rep("N non-point", 3), rep("P point", 3), rep("Widgeon change", 9), "N non-point")
pred = c("Flow", "Agro %", "Development %", "Flow", "Agro %", "Development %", "Flow", "Development %", "Agro %", "Widgeon Density y-1", "Flow", "N non-point", "TSS", "P point", "Widgeon y-1 * P point", "Widgeon y-1 * Flow", "Widgeon y-1 * N non-point", "Widgeon y-1 * TSS", "TSS" )



RmSubETidy <- tidy(tibble(RmSubE.coeftab))

HeightStat_dust_table <- dust(HeightStatTidy) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, 
           fn = quote(pvalString(value))) %>%
  sprinkle_colnames(term = "Term", 
                    statistic = "F-statistic",
                    df = "df",
                    Df.res = "df residual",
                    p.value = "P-value")%>%
  sprinkle(cols = "term", 
           replace = c("Exclusion", "Site", "Exclusion * Site")) %>%
  #sprinkle(rows = 1:2, cols = 5, bold = T) %>%
  kable() %>%
  kable_styling()

HeightStat_dust_table

```

#Flow and Change, Fig 4
```{r build dam flo data}
dam_flow_sp <- connodisc %>% filter(season == "Spring") %>% 
  group_by(year_surv) %>% 
  summarize(me_flo_sp = mean(discharge_cufs), max_flo_sp = max(discharge_cufs), min_flo_sp = min(discharge_cufs)) %>% rename(Year = year_surv)
dam_flow_wi <- connodisc %>% filter(season == "Winter") %>% 
  group_by(year_surv) %>% 
  summarize(me_flo_wi = mean(discharge_cufs), max_flo_wi = max(discharge_cufs), min_flo_wi = min(discharge_cufs)) %>% rename(Year = year_surv)
dam_flow_gr <- connodisc %>% filter(season %in% c("Spring", "Summer")) %>% 
  group_by(year_surv) %>% 
  summarize(me_flo_gr = mean(discharge_cufs), max_flo_gr = max(discharge_cufs), min_flo_gr = min(discharge_cufs)) %>% rename(Year = year_surv)

dam_flow <- connodisc %>% 
  group_by(year_surv) %>% 
  summarize(me_flo = mean(discharge_cufs), max_flo = max(discharge_cufs), min_flo = min(discharge_cufs)) %>% 
  rename(Year = year_surv) %>% 
  left_join(dam_flow_sp) %>% left_join(dam_flow_wi) %>% left_join(dam_flow_gr) %>%
  full_join(SAV %>% select(Year, Hectares, meanRu, meanZo)) %>%
  mutate(meanRu.change = meanRu - lag(meanRu))

ruSTA_me <- Rm_SEM.No0 %>% group_by(year, STATION) %>% summarize(meSTA_ruchange = mean(dens.percomp.change), meSTA_rudwm = mean(dens.weight.mean), meSTA_Area = mean(SAVArea), maxSTA_ruchange = max(dens.percomp.change)) %>% rename(Year = year)

#using this for Fig4 so dont delete yet
floru <- full_join(dam_flow, ruSTA_me) %>% select(Year, STATION, meSTA_ruchange, me_flo_wi, me_flo_sp, me_flo_gr, me_flo) %>% drop_na() 

Flow_RuppiaBae.df = dam_flow %>% drop_na(Year) 
```


```{r Fig4 Stats ru change mean flow Sus }

flow_Rudwm.lm <- lm(meanRu.change ~ log10(me_flo_sp) + log10(me_flo_wi) + log10(me_flo) , data = Flow_RuppiaBae.df)
performance(flow_Rudwm.lm)
car::Anova(flow_Rudwm.lm, test.statistic = "F")
check_model(flow_Rudwm.lm)

```
```{r build Figure 4}
Figure4 = 
  Flow_RuppiaBae.df %>% 
  mutate(me_flo = me_flo / 35.315) %>% #convert cubic feet to cubic meters per second
ggplot(data = .) + #%>% filter(!year== 2018)) +
  geom_hline(yintercept=0, linetype="dashed", color = "red", size = .8) +
 # geom_text(x = 55000, y = 5000, label = lm_eqn(Flow_RuppiaBae.df, 'meanRu.change', 'me_flo'), parse = TRUE) +
  stat_summary(aes(x = me_flo, y = meanRu.change), 
               , size = 1.2,
               geom = "pointrange", fun.data = "mean_se") + 
  stat_smooth(aes(x = me_flo, y = meanRu.change), 
              color = "black", size = 1.4, method = "lm") + 
  xlab("Mean annual flow from mainstem (cu m/sec)") +
  ylab("Annual widgeongrass change (ha)") +
  scale_y_continuous(breaks = c(-7500, -5000, -2500, 0, 2500, 5000, 7500), labels = scales::label_comma()) +
  theme_bw(base_size = 20) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "", 
        plot.margin = unit(c(1,1,1,1), "cm")) 

Figure4
```

Ruflo = ggplot(data = Flow_RuppiaBae.df) + 
  geom_hline(yintercept=0, linetype="dashed", color = "red", size = .8) +
  stat_summary(aes(x = Year, y = meanRu.change), 
               , size = 1.2,
               geom = "pointrange", fun.data = "mean_se") + 
  stat_summary(aes(x = Year, y = meanRu.change), 
               , size = 1.2,
               geom = "line", fun.data = "mean_se") + 
  xlab("Year") +
  ylab("Annual widgeongrass change (ha)") +
  theme_bw(base_size = 20) 
  
Susflo = ggplot(data = Flow_RuppiaBae.df) + 
  stat_summary(aes(x = Year, y = me_flo), 
               , size = 1.2,
               geom = "pointrange", fun.data = "mean_se") + 
  stat_summary(aes(x = Year, y = me_flo), 
               , size = 1.2,
               geom = "line", fun.data = "mean_se") +  
  xlab("Year") +
  ylab("Mean flow") +
  theme_bw(base_size = 20)
  
  Ruflo / Susflo
  

#OLD FIG 4 stuff below: 
```{r Build Fig 4 dataset}
#Spring, Growing, Winter, Annual flow from the Connowingo Dam
dam_flow_sp <- connodisc %>% filter(season == "Spring") %>% group_by(year_surv) %>% summarize(me_flo_sp = mean(discharge_cufs), max_flo_sp = max(discharge_cufs), min_flo_sp = min(discharge_cufs)) %>% rename(Year = year_surv)
dam_flow_wi <- connodisc %>% filter(season == "Winter") %>% group_by(year_surv) %>% summarize(me_flo_wi = mean(discharge_cufs), max_flo_wi = max(discharge_cufs), min_flo_wi = min(discharge_cufs)) %>% rename(Year = year_surv)
dam_flow_gr <- connodisc %>% filter(season %in% c("Spring", "Summer")) %>% group_by(year_surv) %>% summarize(me_flo_gr = mean(discharge_cufs), max_flo_gr = max(discharge_cufs), min_flo_gr = min(discharge_cufs)) %>% rename(Year = year_surv)

dam_flow <- connodisc %>% group_by(year_surv) %>% summarize(me_flo = mean(discharge_cufs), max_flo = max(discharge_cufs), min_flo = min(discharge_cufs)) %>% rename(Year = year_surv) %>% left_join(dam_flow_sp) %>% left_join(dam_flow_wi) %>% left_join(dam_flow_gr)



ruSTA_me <- Rm_SEM.No0 %>% group_by(year, STATION) %>% 
  summarize(meSTA_ruchange = mean(dens.percomp.change), 
            meSTA_rudwm = mean(dens.weight.mean), 
            meSTA_Area = mean(SAVArea), 
            maxSTA_ruchange = max(dens.percomp.change)) %>% rename(Year = year)


floru <- full_join(dam_flow, ruSTA_me) %>% select(Year, STATION, meSTA_ruchange, me_flo_wi, me_flo_sp, me_flo_gr, me_flo) %>% drop_na() 

```


```{r Figure 4 Flow and Ruppia Change}
Figure4 = 
ggplot(data = floru) + #%>% filter(!year== 2018)) +
  geom_hline(yintercept=0, linetype="dashed", color = "red", size = .8) +
  stat_summary(aes(x = me_flo_wi, y = meSTA_ruchange), 
               color = "cornflowerblue", size = 1.2,
               geom = "pointrange", fun.data = "mean_se") + 
  stat_smooth(aes(x = me_flo_wi, y = meSTA_ruchange), 
              color = "cornflowerblue", size = 1.4, method = "lm")+ #, formula = y ~poly(x,2) ) +
  stat_summary(aes(x = me_flo_sp, y = meSTA_ruchange), 
               color = "chartreuse3", size = 1.2,
               geom = "pointrange", fun.data = "mean_se") + 
  stat_smooth(aes(x = me_flo_sp, y = meSTA_ruchange), 
              color = "chartreuse3", size = 1.4,
              method = "lm") +#, formula = y ~poly(x,2) ) +
  geom_labelsmooth(label = "Winter",
                   aes(x = me_flo_wi, y = meSTA_ruchange), color = "cornflowerblue",
                   method = "lm", boxlinewidth = 2, size = 8) +
  geom_labelsmooth(label = "Spring",
                   aes(x = me_flo_sp, y = meSTA_ruchange), color = "chartreuse3",
                   method = "lm", boxlinewidth = 2, size = 8) +
  xlab("Mean seasonal flow from mainstem (cu ft/s)") +
  ylab("Mean widgeongrass change \n (per site)") +
  scale_x_continuous(breaks = c(20000, 40000, 60000, 80000, 100000, 120000), labels = scales::label_comma()) +
  theme_bw(base_size = 20) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

Figure4
```

```{r Figure 4 flow}
Figure4_log = 
ggplot(data = floru) + #%>% filter(!year== 2018)) +
  geom_hline(yintercept=0, linetype="dashed", color = "red", size = .8) +
  stat_summary(aes(x = log10(me_flo_wi), y = meSTA_ruchange), 
               color = "cornflowerblue", size = 1.2,
               geom = "pointrange", fun.data = "mean_se") + 
  stat_smooth(aes(x = log10(me_flo_wi), y = meSTA_ruchange), 
              color = "cornflowerblue", size = 1.4, method = "lm") + #, formula = y ~poly(x,2) ) +
  stat_summary(aes(x = log10(me_flo_sp), y = meSTA_ruchange), 
               color = "chartreuse3", size = 1.2,
               geom = "pointrange", fun.data = "mean_se") + 
  stat_smooth(aes(x = log10(me_flo_sp), y = meSTA_ruchange), 
              color = "chartreuse3", size = 1.4,
              method = "lm") +#, formula = y ~poly(x,2) ) +
  geom_labelsmooth(label = "Winter",
                   aes(x = log10(me_flo_wi), y = meSTA_ruchange), color = "cornflowerblue",
                   method = "lm", boxlinewidth = 2, size = 8) +
  geom_labelsmooth(label = "Spring",
                   aes(x = log10(me_flo_sp), y = meSTA_ruchange), color = "chartreuse3",
                   method = "lm", boxlinewidth = 2, size = 8) +
  xlab("Mean seasonal flow from mainstem (cu ft/s)") +
  ylab("Mean widgeongrass change \n (per site)") +
 # scale_x_continuous(breaks = c(20000, 40000, 60000, 80000, 100000, 120000), labels = scales::label_comma()) +
  theme_bw(base_size = 20) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

Figure4_log
```



```{r, conno flow stats}
#USE THE ANNUAL DATA FOR THE STATS
#repetitive stations is for visualization of the variation in change, so there is an error around each point, but doesnt make sense to model! 

ruSTA_me_BAY <- Rm_SEM.No0 %>% group_by(year) %>% 
  summarize(meSTA_ruchange = mean(dens.percomp.change), 
            sumSTA_ruchange = sum(dens.weight.mean) - sum(dens.weight.mean.y1)) %>% 
  rename(Year = year)

floru_BAY <- full_join(dam_flow, ruSTA_me_BAY) %>% select(Year,  meSTA_ruchange, sumSTA_ruchange, me_flo_wi, me_flo_sp, me_flo_gr, me_flo) %>% drop_na()

#.27
flow_Ruchange.lm <- lm(log10(dens.tot_STA) ~ log10(me_flo_sp) + log10(me_flo_wi) , data = Flow_RuppiaBae.df) #%>% filter(!Year== 2018))
car::Anova(flow_Ruchange.lm)
performance(flow_Ruchange.lm)

#simple but .25
meflo_sumRuchange.lm <- lm(sumSTA_ruchange ~  log10(me_flo), data = floru_BAY)
car::Anova(meflo_sumRuchange.lm)
check_model(meflo_sumRuchange.lm)
performance(meflo_sumRuchange.lm)

flow_Ruchange.nlm <- lm(meSTA_ruchange ~ me_flo_sp + me_flo_wi + I(me_flo_sp^2) + I(me_flo_wi^2) , data = floru_BAY) 
car::Anova(flow_Ruchange.nlm)
check_model(flow_Ruchange.nlm)
performance(flow_Ruchange.nlm)
r2(flow_Ruchange.nlm)

AIC(flow_Ruchange.lm, flow_Ruchange.nlm, flow_Rudwm.lm)

#this one fits best, but IDK seems kinda fucked up
flow_Rudwm.lm <- glm(log10(sumSTA_ruchange) ~ log10(me_flo_sp) * log10(me_flo_wi) * log10(me_flo_gr) * log10(me_flo) , family = gaussian, data = floru_BAY)
car::Anova(flow_Rudwm.lm)
check_model(flow_Rudwm.lm)
performance(flow_Rudwm.lm)
r2(flow_Rudwm.lm)


```


```{r original discharge over time}

#flow and change regression
lm_eqn <- function(df, y, x){
    formula = as.formula(sprintf('%s ~ %s', y, x))
    m <- lm(formula, data=df);
    # formating the values into a summary string to print out
    # ~ give some space, but equal size and comma need to be quoted
    eq <- substitute(italic(target) == a + b %.% italic(input)*","~~italic(r)^2~"="~r2*","~~p~"="~italic(pvalue), 
         list(target = y,
              input = x,
              a = format(as.vector(coef(m)[1]), digits = 2), 
              b = format(as.vector(coef(m)[2]), digits = 2), 
             r2 = format(summary(m)$r.squared, digits = 3),
             # getting the pvalue is painful
             pvalue = format(summary(m)$coefficients[2,'Pr(>|t|)'], digits=1)
            )
          )
    as.character(as.expression(eq));                 
}


ggplot(data = floru) + #%>% filter(!year== 2018)) +
  stat_summary(aes(x = me_flo_sp, y = meanRu), color = "black", geom = "pointrange", fun.data = "mean_se") + 
  geom_text(x = 55000, y = 0.1, label = lm_eqn(floru, 'meanRu', 'me_flo'), parse = TRUE) +
  geom_smooth(aes(x = me_flo_sp, y = meanRu), color = "black", method = "lm") +
  xlab("Mean annual flow from mainstem (cu ft/s)") +
  ylab("Mean widgeongrass change \n (per site)") +
  theme_bw(base_size = 20) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")


conno_annual <- 
  ggplot(data = connodisc %>% filter(between(year_nu, "1986", "2019"))) + 
  stat_summary(aes(x = year_nu, y = discharge_cufs), fun.data = mean_cl_normal, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark blue") +
  stat_summary(aes(x = year_nu, y = discharge_cufs), fun.data = mean_se, geom = "line", fun.args = list(mult = 1), size = 1.5, color = "dark blue") +
  theme_bw(base_size=20) + 
  ylab("Mean annual discharge") + xlab("") +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right")

#change graph looks better
Fig4 = RuChange_Station / conno_annual + plot_annotation(tag_levels = 'A')

#area graph is hard to compare
RuArea_Station / conno_annual


```

####Explore Y1 -> change relationships
```{r, y1 ruppia vs change}

  ggplot(data = Rm_SEM) + 
  stat_summary(aes(x = dens.percomp.y1, y = dens.percomp.change), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "black") +
  geom_smooth(aes(x = dens.percomp.y1, y = dens.percomp.change), method = "lm", alpha = 0.5, size = .5) +
  theme_bw(base_size=20) + 
  labs(y = "Ruppia change", x = "Ruppia coverage in previous year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

  ggplot(data = RmSubE988_SEM) + 
  stat_summary(aes(x = dens.percomp.y1, y = dens.percomp.change), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "black") +
  geom_smooth(aes(x = dens.percomp.y1, y = dens.percomp.change), method = "lm", alpha = 0.5, size = .5) +
  theme_bw(base_size=20) + 
  labs(y = "Ruppia change", x = "Ruppia coverage in previous year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

  ggplot(data = Rm_SEM) + 
  stat_summary(aes(x = dens.percomp.y1, y = dens.percomp), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "black") +
  geom_smooth(aes(x = dens.percomp.y1, y = dens.percomp), method = "lm", alpha = 0.5, size = .5) + 
  ylim(0,1)+xlim(0,1) +
  theme_bw(base_size=20) + 
  labs(y = "Ruppia coverage this year", x = "Ruppia coverage in previous year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
  
```

#WQ over time (station)
```{r, WQ over time (station)}
Rudens.time =     
ggplot(data = Rm_SEM.No0) + 
  #stat_summary(aes(x = year, y = dens.percomp), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "black") +
    stat_summary(aes(x = year, y = SAVArea), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "black") + 
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "Ruppia Area (HA)", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
Sal.time = 
  ggplot(data = Rm_SEM.No0) + 
  #stat_summary(aes(x = year, y = Sal.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
  stat_summary(aes(x = year, y = Sal.spme), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "grey") + 
  stat_summary(aes(x = year, y = Sal.sumy1me), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "yellow") + 
    stat_summary(aes(x = year, y = Sal.spmin), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "blue") + 
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "Salinity Spring", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
ChlA.time = 
  ggplot(data = Rm_SEM.No0) + 
  #stat_summary(aes(x = year, y = ChlA.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark green") +
  stat_summary(aes(x = year, y = ChlA.spme), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "dark green") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "ChlA Spring", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

TN.time = 
  ggplot(data = Rm_SEM.No0) + 
  #stat_summary(aes(x = year, y = TN.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "green") +
  stat_summary(aes(x = year, y = TN.spme), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "green") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "TN Spring", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

TP.time = 
  ggplot(data = Rm_SEM.No0) + 
  #stat_summary(aes(x = year, y = TP.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
  stat_summary(aes(x = year, y = TP.spme), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "dark red") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "TP Spring", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

Temp.time = 
  Rm_SEM.No0 %>% 
  group_by(STATION, year) %>% 
  mutate(year.y1 = year - 1) %>% select(year.y1, Temp.sumy1me) %>%
  ggplot(data = .) + 
  #stat_summary(aes(x = year, y = Temp.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
  stat_summary(aes(x = year, y = Temp.sumy1me), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "dark red") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "Summer Temp (oC)", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
Temp.time

time.figs = Rudens.time / Sal.time /ChlA.time / TN.time / TP.time

Rudens.time / Sal.time
```

  ggplot(data = Rm_SEM.No0) + 
  stat_summary(aes(y = dens.weight.mean, x = Sal.spme), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "cyan1") + 
    stat_smooth(aes(y = dens.weight.mean, x = Sal.spme), method = "gam", alpha = 0.8, size = 1, color = "cyan1") + 
  stat_summary(aes(y = dens.weight.mean, x = Sal.sumy1me), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "yellow") + 
      stat_smooth(aes(y = dens.weight.mean, x = Sal.sumy1me), method = "gam", alpha = 0.8, size = 1, color = "yellow") + 
    stat_summary(aes(y = dens.weight.mean, x = Sal.spmin), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "blue") + 
          stat_smooth(aes(y = dens.weight.mean, x = Sal.spmin), method = "gam", alpha = 0.8, size = 1, color = "blue") + 
  theme_bw(base_size=18) + 
  labs(y = "SAV dens.weight.mean", x = "Salinity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
  
  ggplot(data = Rm_SEM.No0) + 
  stat_summary(aes(y = SAVArea, x = Sal.spme), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "cyan1") + 
    stat_smooth(aes(y = SAVArea, x = Sal.spme), method = "gam", alpha = 0.8, size = 1, color = "cyan1") + 
  stat_summary(aes(y = SAVArea, x = Sal.sumy1me), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "yellow") + 
      stat_smooth(aes(y = SAVArea, x = Sal.sumy1me), method = "gam", alpha = 0.8, size = 1, color = "yellow") + 
    stat_summary(aes(y = SAVArea, x = Sal.min), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "blue") + 
          stat_smooth(aes(y = SAVArea, x = Sal.min), method = "gam", alpha = 0.8, size = 1, color = "blue") + 
      stat_summary(aes(y = SAVArea, x = Sal.max), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "red") + 
      stat_smooth(aes(y = SAVArea, x = Sal.max), method = "gam", alpha = 0.8, size = 1, color = "red") + 
  theme_bw(base_size=18) + 
  labs(y = "SAV Area", x = "Salinity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
  
    ggplot(data = Rm_SEM.No0 %>% filter(dens.change > 100)) + 
  stat_summary(aes(y = dens.change, x = TN.spme), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "cyan1") + 
    stat_smooth(aes(y = dens.change, x = TN.spme), method = "gam", alpha = 0.8, size = 1, color = "cyan1") + 
  stat_summary(aes(y = dens.change, x = TN.sumy1me), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "yellow") + 
      stat_smooth(aes(y = dens.change, x = TN.sumy1me), method = "gam", alpha = 0.8, size = 1, color = "yellow") + 
  theme_bw(base_size=18) + 
  labs(y = "SAV dens.change", x = "TN") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
  
      ggplot(data = Rm_SEM.No0 %>% filter(dens.change < -100)) + 
  stat_summary(aes(y = dens.change, x = TN.spme), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "cyan1") + 
    stat_smooth(aes(y = dens.change, x = TN.spme), method = "gam", alpha = 0.8, size = 1, color = "cyan1") + 
  stat_summary(aes(y = dens.change, x = TN.sumy1me), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "yellow") + 
      stat_smooth(aes(y = dens.change, x = TN.sumy1me), method = "gam", alpha = 0.8, size = 1, color = "yellow") + 
  theme_bw(base_size=18) + 
  labs(y = "SAV dens.change", x = "TN") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
  
    ggplot(data = Rm_SEM.No0 %>% filter(SAVArea.change > 100)) + 
    stat_summary(aes(y = SAVArea.change, x = Sal.spme), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "cyan3") + 
    stat_smooth(aes(y = SAVArea.change, x = Sal.spme), method = "gam", alpha = 0.7, size = 1, color = "cyan3") + 
    stat_summary(aes(y = SAVArea.change, x = Sal.sumy1me), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "yellow") + 
      stat_smooth(aes(y = SAVArea.change, x = Sal.sumy1me), method = "gam", alpha = 0.7, size = 1, color = "yellow") + 
      theme_bw(base_size=18) + 
      labs(y = "SAV Area", x = "Salinity") + 
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
      
       ggplot(data = Rm_SEM.No0 %>% filter(SAVArea.change < -100)) + 
    stat_summary(aes(y = SAVArea.change, x = Sal.spme), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "cyan3") + 
    stat_smooth(aes(y = SAVArea.change, x = Sal.spme), method = "gam", alpha = 0.7, size = 1, color = "cyan3") + 
    stat_summary(aes(y = SAVArea.change, x = Sal.sumy1me), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "yellow") + 
      stat_smooth(aes(y = SAVArea.change, x = Sal.sumy1me), method = "gam", alpha = 0.7, size = 1, color = "yellow") + 
      theme_bw(base_size=18) + 
      labs(y = "SAV Area", x = "Salinity") + 
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
      
          ggplot(data = Rm_SEM.No0) + 
    stat_summary(aes(y = TN.spme, x = Sal.spme), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "cyan3") + 
    stat_smooth(aes(y = TN.spme, x = Sal.spme), method = "gam", alpha = 0.7, size = 1, color = "cyan3") + 
    stat_summary(aes(y = TN.spme, x = Sal.sumy1me), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "yellow") + 
      stat_smooth(aes(y = TN.spme, x = Sal.sumy1me), method = "gam", alpha = 0.7, size = 1, color = "yellow") + 
      theme_bw(base_size=18) + 
      labs(y = "TN", x = "Salinity") + 
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")


#Loads over time (SubEs)
```{r, Loads over time (SubEs)}
#subestuary time figs
Rudens.timeSubE =     
ggplot(data = RmSubE988_SEM) + 
  #stat_summary(aes(x = year, y = dens.percomp), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "black") +
    stat_summary(aes(x = Year, y = SAVArea), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "black") + 
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "Ruppia Area (HA)", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
NPTN.time = 
  ggplot(data = RmSubE988_SEM) + 
  #stat_summary(aes(x = year, y = Sal.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
  stat_summary(aes(x = Year, y = log10(nptn.adj)), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "green") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "NPTN", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
flow.time = 
  ggplot(data = RmSubE988_SEM) + 
  #stat_summary(aes(x = year, y = Sal.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
  stat_summary(aes(x = Year, y = log10(flow)), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "blue") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "Flow", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

TSS.time = 
  ggplot(data = RmSubE988_SEM) + 
  #stat_summary(aes(x = year, y = Sal.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
  stat_summary(aes(x = Year, y = log10(tssx.adj)), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "brown") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "TSS", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")


time.figs_SubE = Rudens.timeSubE / NPTN.time / flow.time / TSS.time

```




```{r}
sal1 = 
  ggplot(data = Rm_SEM %>% filter(!year > 2013)) + 
  #stat_summary(aes(x = year, y = TP.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
  stat_summary( aes(x = year, y = Sal.spme), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "grey") + 
  #stat_summary(data = RmSubE988_SEM, aes(x = Year, y = log10(flow)), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "blue") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "Salinity Spring", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")
flow1 =
  ggplot() + 
  #stat_summary(aes(x = year, y = TP.spme), fun.data = mean_se, geom = "pointrange", fun.args = list(mult = 1), size = .9, color = "dark red") +
 # stat_summary(data = Rm_SEM, aes(x = year, y = log10(Sal.spme)), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "grey") + 
  stat_summary(data = RmSubE988_SEM, aes(x = Year, y = flow), fun.data = mean_se, geom = "smooth", alpha = 0.5, size = 1.2, color = "blue") + 
 # ylim(0,1) +
  scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "Flow", x = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

sal1 / flow1

```

```{r}
annualflow = RmSubE988_SEM %>% rename(year = Year) %>%
  group_by(year) %>% summarise(flow.ann = mean(flow), dwmSub = mean(dens.percomp))

annualsal = Rm_SEM %>%
  group_by(year) %>% summarise(sal.ann = mean(Sal.spme), dwmSta = mean(dens.percomp))

annualflowsal = full_join(annualsal, annualflow)

flowsal.lm = lm(sal.ann ~ flow.ann, data = annualflowsal %>% drop_na())
car::Anova(flowsal.lm)
r2(flowsal.lm)
densfs.lm = lm(dwmSta ~ sal.ann * flow.ann, data = annualflowsal)
car::Anova(densfs.lm)

```


```{r}

  ggplot(data = annualflowsal) + 
  stat_summary(aes(x = sal.ann, y = flow.ann), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "blue") + 
  geom_smooth(aes(x = sal.ann, y = flow.ann), method = "lm", alpha = 0.5, size = .5) +
  theme_bw(base_size=18) + 
  labs(y = "Flow", x = "Spring Salinity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

  ggplot(data = annualflowsal) + 
  stat_summary(aes(x = log10(sal.ann), y = log10(flow.ann)), fun.data = mean_se, geom = "point", alpha = 0.5, size = 1.2, color = "blue") + 
  geom_smooth(aes(x = log10(sal.ann), y = log10(flow.ann)), method = "lm", alpha = 0.5, size = .5) +
  #scale_x_continuous(breaks=c(1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020)) +
  theme_bw(base_size=18) + 
  labs(y = "log Flow", x = "log Spring Salinity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "")

```

